<section>
  <div class="alert alert-warning" role="alert" *ngIf="getTotalItems() === 0">
    Search for projects to add to your collection.
  </div>

  <p class="alert alert-warning" *ngIf="resultDataSource.data.length === 0 && searched && !loadStatus()">
    No results found
  </p>

  <p class="alert alert-warning" *ngIf="onSearchError">
    An error occured during search
  </p>

  <div class="box-padding">
    <form #form="ngForm">
      <div class="search_bar">
        <div class="row">
          <div class="column is-9 search-input">

            <mat-form-field class="search_align">
              <input matInput #query="ngModel" name="query" placeholder="" required [(ngModel)]="model.query">
            </mat-form-field>

          </div>
          <div class="column is-3 searh-btn-lh">
            <button mat-raised-button type="submit" [disabled]="query.value === '' || query === undefined" (click)="search(model.query)"
              class="btn-left-mrgn btn-mrgn btn align-middle">
              Search
            </button>
            <span class="btn-left-mrgn">
              <button mat-raised-button class="btn btn-mrgn btn-sm align-middle" (click)="isFilterVisible = true"
                *ngIf="!isFilterVisible">
                Show Filtering Options
              </button>
              <button mat-raised-button class="btn btn-sm btn-mrgn align-middle" *ngIf="isFilterVisible"
                (click)="isFilterVisible = false">
                Hide Filtering Options
              </button>
            </span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div [ngClass]="isFilterVisible ? 'show' : 'hide'">
    <mat-form-field>
      <input matInput placeholder="Filter" (keyup)="filter($event.target.value)" />
    </mat-form-field>
    <table mat-table [dataSource]="filterDataSource" class="mat-elevation-z8">
      <ng-container matColumnDef="filter">
        <th mat-header-cell *matHeaderCellDef>Filter</th>
        <td mat-cell *matCellDef="let row">{{ row.filter }}</td>
      </ng-container>
      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef>Value</th>
        <td mat-cell *matCellDef="let row">
          <input matInput [(ngModel)]="row.value" placeholder="> 1" />
        </td>
      </ng-container>
      <ng-container matColumnDef="operand">
        <th mat-header-cell *matHeaderCellDef>Operand</th>
        <td mat-cell *matCellDef="let row">
          <mat-button-toggle-group [value]="row.operand" (change)="toggleOperand($event, row)">
            <mat-button-toggle value="&&">&&</mat-button-toggle>
            <mat-button-toggle value="||">||</mat-button-toggle>
          </mat-button-toggle-group>
        </td>
      </ng-container>
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef>Action</th>
        <td mat-cell *matCellDef="let row">
          <button mat-raised-button (click)="applyFilter(row)">Apply</button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="filterColumns"></tr>
      <tr mat-row *matRowDef="let rowDef; columns: filterColumns"></tr>
    </table>
    <mat-paginator #filterPaginator [pageSizeOptions]="[5, 10, 20]" [length]="filterDataSource.data.length"
      showFirstLastButtons></mat-paginator>
  </div>

  <!-- Search result list -->
  <div id="results" class="box-padding" *ngIf="resultDataSource.data.length > 0">
    <h5>{{ resultDataSource.data.length }} Result(s)</h5>
    <br />
    <mat-form-field>
      <input matInput (keyup)="applyDataSourceFilter($event.target.value)" placeholder="Filter" />
    </mat-form-field>
    <table #resultsTable mat-table matSort [dataSource]="resultDataSource" class="mat-elevation-z8">
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let row">{{ row.project_id }}</td>
      </ng-container>

      <ng-container matColumnDef="metric">
        <th mat-header-cell *matHeaderCellDef>Metric</th>
        <td mat-cell *matCellDef="let row">
          <div *ngFor="let entry of row.metric | keyvalue">
            {{entry.key}} : {{entry.value}}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="source">
        <th mat-header-cell *matHeaderCellDef>Source</th>
        <td mat-cell *matCellDef="let row">
          {{row.source}}
        </td>
      </ng-container>

      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="$event ? selectDeselectAll() : null" [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="(null)" (change)="$event ? select(row) : null" [checked]="selection.isSelected(row)"
            [(ngModel)]="row.singleSelection">
          </mat-checkbox>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="searchColumns"></tr>
      <tr mat-row *matRowDef="let rowDef; columns: searchColumns"></tr>
    </table>

    <mat-paginator #resultPaginator [pageSizeOptions]="[5, 10, 20]" [length]="resultDataSource.data.length"
      showFirstLastButtons></mat-paginator>
  </div>

  <!-- Selected project list -->
  <div style="max-height:1000px;overflow:auto">
    <h5 class="float-left" style="margin-top:0px" *ngIf="getTotalItems() > 0">
      <!-- {{ getTotalItems() | projectCount }} Selected -->
    </h5>

    <div class="col-lg-12 text-right box-padding" *ngIf="getTotalItems() > 0">
      <button mat-raised-button class="btn btn-mrgn btn-sm align-middle" *ngIf="!isFromOtherPage()" (click)="addAll()">
        Add Selected Projects to a existing Collection
      </button>
      <button mat-raised-button class="btn btn-mrgn btn-sm align-middle" *ngIf="!isFromOtherPage()" (click)="createCollection()">
        Create New Collection
      </button>
      <button mat-raised-button class="btn btn-mrgn btn-sm align-middle" *ngIf="!isFromOtherPage()" (click)="removeCart()">Remove all</button>
      <button mat-raised-button class="btn btn-mrgn btn-sm align-middle" *ngIf="isFromOtherPage()" (click)="addProjects()">Add to Version</button>
    </div>

    <div class="col-lg-12" *ngIf="getTotalItems() > 0" style="max-height:600px">
      <table mat-table [dataSource]="toAdd" class="mat-elevation-z8">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let row">{{ row.project_id }}</td>
        </ng-container>

        <ng-container matColumnDef="metric">
          <th mat-header-cell *matHeaderCellDef>Metric</th>
          <td mat-cell *matCellDef="let row">
            <div *ngFor="let entry of row.metric | keyvalue">
              {{entry.key}} : {{entry.value}}
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef>Source</th>
          <td mat-cell *matCellDef="let row">
            {{row.source}}
          </td>
        </ng-container>

        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row">
            <button mat-raised-button class="btn btn-sm" (click)="removeItem(row)">
              Remove
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="addColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: addColumns"></tr>
      </table>
    </div>
  </div>

  <!-- loading -->
  <div class="wrapper" *ngIf="loadStatus()">
    <h2>Searching</h2>
    <span class="cssload-loader"></span>
  </div>
</section>